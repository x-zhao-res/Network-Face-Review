## 内容简介

1. OSPF基础介绍
2. OSPF报文类型
3. OSPF邻居状态机
4. OSPF三张表
5. OSPF-LSA
6. OSPF特殊区域
7. DR和BDR选举过程
8. OSPF接口类型及应用场景
9. OSPF时间状态机
10. OSPF认证
11. OSPF收敛协议算法
12. OSPF Option详解
13. LSDB的构成(详细)

### OSPF基础介绍

OSPF全称开放式最短路径优先协议*(Open Shortest Path First)*,是一个**基于链路**的内部网关协议。

在OSPF出现前，网络上广泛使用RIP作为内部网关协议，由于**RIP是基于距离矢量算法**的路由协议，存在着收敛慢、路由环路、可扩展性差等问题，所以逐渐被OSPF取代。

OSPF的IP协议号为89

### OSPF报文类型

|  报文名称  |                      报文作用                      |
| :--------: | :------------------------------------------------: |
| Hello报文  |       周期性发送，用来发现和维持OSPF邻居关系       |
|   DD报文   | 描述本地LSDB的摘要信息，用于两台设备进行数据库同步 |
|  LSR报文   |              用于向对方请求所需的LSA               |
|  LSU报文   |     根据DD报文和LSR报文向对方发送其所需要的LSA     |
| LSAck 报文 |              用来对收到的LAS进行确认               |

> 请注意，LSR只有在通信双方都交换DD报文后才会向对方发送LSR报文。
>
> 默认情况下，LSU报文会以周期为1800s动态更新，dead time为3600s
>
> LSU会被网络中的行为进行触发更新

### OSPF邻居状态机

| 状态名称 |                           状态描述                           |
| :------: | :----------------------------------------------------------: |
|   Down   | 邻居会话的初始阶段，表明没有在邻居失效时间间隔内收到来自邻居路由器的hello数据包 |
| Attempt  | 该状态仅发生在NBMA网络中，表明对端在***Dead Time***超时前仍然没有回复Hello报文，此时路由器依然会发送 |
|   Init   |                  收到Hello报文后状态为Init                   |
|  2-way   | 收到Hello报文中含有自己的Router ID，则状态为2-way；如果不需要形成邻接关系则邻居状态机停留在2-way状态 |
| Exstart  |    开始协商主从关系，并确定DD的序列号，此时状态为Exstart     |
| Exchange |     主从关系协商完毕后开始交换DD报文，此时状态为Exchange     |
| Loading  |    DD报文交换完成即为**Exchange done**,此时状态为Loading     |
|   Full   |                 LSR重传为空，此时状态为Full                  |

>Attempt状态是NBMA网络类型的独有状态，其他网络类型是没有的。

### OSPF 三张表

#### 邻居表

在ospf交互链路状态通告之前，两台直连路由器需建立OSPF邻居关系，当一个接口激活OSPF后，该接口周期性的发送hello报文，同时开始侦探hello报文从而发现链路上的OSPF邻居，交换链路信息

#### 链路状态数据库

展示网络中其他路由器的信息，**以LSA的形式**，也显示了全网的拓扑

#### OSPF路由表

因为LSDB中存在着全网的拓扑，那么到达某个目的地的路径可能不止一个，所以我们在OSPF路由表中放置所有路径，然后经过算法筛选出最优路径放置在路由表中。

> 请不要混淆路由器路由表和OSPF路由表

### OSPF-LSA

|          LSA类型          |                             作用                             |
| :-----------------------: | :----------------------------------------------------------: |
|     Router-LSA（T1）      | 所有运行了OSPF的设备都会产生，描述了设备的链路状态和开销，在所属的区域内传播 |
|     Network-LSA（T2）     |      由DR产生，描述本网段的链路状态，在所属的区域内传播      |
| Network-Summary-LSA（T3） | 由ABR产生，描述区域内某个网段的路由，不会给Totally STUB或NSSA区域 |
|  ASBR-Summary-LSA（T4）   | 由ABR产生，描述到ASBR的路由，通告给除了ASBR所在区域的其他相关区域 |
|   AS-external-LSA（T5）   |       由ASBR产生，描述到AS外部的路由，通告到所有的区域       |
|  Opaque LSA（T 9 10 11）  |             用于MPLS TE的链路信息传输--暂时不写              |

> 其中LSA 9 10 11是在MPLS TE中被用来传递链路信息的，提供给RSVP帮助其进行选路的，同样会这样适配的还有IS-IS协议

### OSPF特殊区域

#### 表格概览

|     区域类型     |  T1  |  T2  |  T3  |  T4  |  T5  |  T7  |
| :--------------: | :--: | :--: | :--: | :--: | :--: | :--: |
|     普通区域     |  √   |  √   |  √   |  √   |  √   |  √   |
|     Stub区域     |  √   |  √   |  √   |  ×   |  ×   |  ×   |
| Totally Stub区域 |  √   |  √   |  ×   |  ×   |  ×   |  ×   |
|     NSSA区域     |  √   |  √   |  √   |  ×   |  ×   |  √   |
| Totally Stub区域 |  √   |  √   |  ×   |  ×   |  ×   |  √   |

> 只要是特殊区域 LSA-4 和 LSA-5 都不让进，Totally区域不让 LSA-3 进，NSSA区域统一允许 LSA-7 进入
>
> 请注意，ABR会统一下发三类网关

#### Stub & Totally Stub

这两个区域都是为了掩盖自身路由，并且减少内部路由的传递，这类通常被叫做末端路由

特点：

1. 存在一个或多个ABR
2. 不存在ASBR
3. 不为区域0
4. 无虚链路

作用

1. 拒绝三四五类路由（Totally拒绝三类）
2. 下发三类LSA默认路由

#### NSSA & Totally NSSA

这个区域是为了将四类+五类的外部路由简化而使用的路由

特点：

1. 允许存在ASBR
2. 该区域ASBR引入的外部路由会转化为七类路由
3. NSSA不会通告默认路由，Totally会
4. 七类转五类

### DR和BDR选举过程

第一步：选举BDR：只是没有声称自己是DR的路由器才可能称为BDR。如果只有一个，那么他就是BDR，如果有多个，进入选举阶段，如果没有人宣告，那么也进入自动选举（前提是没有宣告自己为DR）

第二步：选举DR：同上，但是如果没有人宣布自己是DR，则新选出来的BDR为DR（这时他们是同一台路由器）

选举时间点：当一台路由器加入一个网络的时候，它开始一个waiting定时器，如果发现有人声称自己是DR的话，就开始选举，计时器重置，这个事件大概是30s，那么如果此时有人声称为DR，则称为DRother；加入DR挂了，那么这个人既可能是BDR也可能是DRother。那么在30s之后加入的，就算优先级超级高，那么此时也不允许抢占DR和BDR了。

> 如果OSPF的路由优先级被设置为了0，那么标识这个路由器在选举的时候永远不可能称为DR或BDR，也就是不参与竞选。

### OSPF接口类型及场景

| 网络类型  |    工作方式    |        是否选择DR/BDR        |
| :-------: | :------------: | :--------------------------: |
| Loopback  |   无hello包    | 不选举，根据32位主机路由加表 |
|    p2p    | hello time 10s |     不选举，自动建立邻居     |
| Broadcast | hello time 10s |    选DR/BDR，自动建立邻居    |
|   NBMA    | hello time 30s |   自动建立邻居，不选DR/BDR   |

#### Loopback

其实要注意的只有一点，因为OSPF协议是以32位主机路由传递的，如果使用了重分布技术，要么你就把环回改为32位（如果你使用了24位就会产生传递问题，尤其是MPLS VPN那块，懂的都懂），要么你就把接口改为点对点接口。

### OSPF时间状态机

OSPF HELLO默认为10s

OSPF DEAD默认为 OSPF HELLO * 4

OSPF LSA 30min 更新一次

OSPF LSA 60min 进入老化进程

### OSPF认证

| 使用区域 | 密钥配置 | 启用关系 |
| :------: | :------: | :------: |
|   接口   |   接口   |   接口   |
|   区域   |   接口   |   进程   |
|  虚链路  |   进程   |   进程   |

OSPF认证分为明文认证和密文认证，这个比较简单就不多赘述了。虚链路也是一种简单的接口认证，区域也是在相应的接口认证。

### OSPF-Dijkstra算法

就是找到单源最短路径的过程，在RFC2328中第二章的拓扑上他举了一个例子，就是随便找一台路由器作为根，那么这台路由器构建出的树就是最短路径树，也是整个网络的最短路径树，因为单源最短算法计算出来的树肯定是相同的。

### OSPF Option

| 位名称 |                             解释                             |
| :----: | :----------------------------------------------------------: |
|   DN   | 用来避免MPLS VPN中产生环路，但是如果你用的是MPLS VPN OPTION A的时候，就需要对OSPF进行一些特殊的配置 |
|   O    |        表明是否有能力接收或者发送Opaque LSA(MPLS VPN)        |
|   DC   |     始发路由器支持按需链路上的OSPF的能力时，该位将被设置     |
|   EA   |      当始发路由器具有接收和转发外部属性LSA的时候，置位       |
|  N/P   |        表明是否支持七类LSA和是否支持七类转化为五类LSA        |
|   MC   |                      表明是否支持MOSPF                       |
|   E    |               是否具有接收OSPF域外部LSA的能力                |
|   MT   |                  表示始发路由器支持MT-OSPF                   |
|   R    |            用来标识设备是否具有转发能力的路由器。            |
|   V    |                   若为0，则不参加路由计算                    |

