## 内容简介

1. BGP简介&基础内容
2. BGP分类（角色、域）
3. BGP消息（报文）
4. BGP邻居状态机
5. BGP对等体交互原则
6. BGP时间状态机
7. next-hop-self
8. update-source
9. BGP同步
10. BGP属性
11. RR路由反射器
12. BGP邦联
13. BMP
14. BGP GR/NSR
15. BGP ORF
16. BGP分层路由

### BGP简介&基础内容

BGP（Border Gateway Protocol）边界网关路由协议，是一种EGP，不同于IGP的是它工作在AS与AS之间，为AS和AS传递路由，BGP使用TCP为其进行传输，监听端口为179。

BGP路由更新为增量更新，大大减少了链路负担，并且BGP是Loop-Free路由协议。

BGP支持CIDR

### BGP分类（角色、域）

EBGP：AS之间建立的BGP对等体邻居关系

IGBP：AS内部建立的BGP对等体邻居关系

### BGP消息

|     报文名称     |                 作用                 |
| :--------------: | :----------------------------------: |
|     Open报文     |        用于建立BGP对等体连接         |
|    Update报文    |     用于在对等体之间交换路由信息     |
| Notification报文 |           用于中断BGP连接            |
|  Keepalive报文   |           用于保持BGP连接            |
|  Route-Refresh   | 用于改变策略后请求对等体重新发送路由 |

Open报文是在TCP连接建立后发送的第一个消息，用于建立BGP对等体之间的连接关系

Keepalive报文是BGP周期性向对等体发送的消息，用于保持连接有效性

### BGP邻居状态机

|    状态     |    名称    |                          意义及作用                          |
| :---------: | :--------: | :----------------------------------------------------------: |
|    Idle     |    空闲    | 该状态是BGP的初始状态。在Idle状态下，BGP拒绝邻居发送的连接请求 |
|   Connect   |    连接    |       该状态下，BGP启动连接重传定时器，等待TCP完成连接       |
|   Active    |    活跃    |              该状态下，BGP总是在试图建立TCP连接              |
|  OpenSent   | 报文已发送 | 该状态下，BGP等待对等体的Open报文，并对收到的报文进行信息检查 |
| OpenConfirm | 报文已确认 |               该状态下，BGP等待Keep或Notif报文               |
| Established | 连接已建立 |    如果OpenConfirm为Keep，则转化为该状态，可正常传递路由     |

#### Connect

如果TCP连接成功，那么BGP向对等体发送**Open报文**

如果TCP连接失败，那么BGP转至**Active状态**

#### Active

如果TCP连接成功，那么BGP向对等体发送**Open报文**，关闭连接重传定时器

如果TCP连接失败，那么BGP停留在**Active状态**

#### OpenSent

如果收到的Open报文正确，那么BGP发送**Keepalive报文**，转至**OpenConfirm状态**

如果Open报文错误，那么会发送Notif报文回去，转至**Idle状态**

#### OpenConfirm

BGP等待Keepalive或者notifi

Keepalive：**Established**

Notif：**Idle**

#### Established

Route-Refresh报文不会改变BGP状态

收到错误的报文或者Notif，则转换到**Idle状态**

### BGP对等体交换原则

从IBGP对等体获得的BGP路由，BGP设备只发布给它的EBGP对等体

从EBGP对等体获得的BGP路由，BGP设备发布给它所有EBGP和IBGP对等体

当存在多条到达同一目的地址的有效路由时，BGP设备只将最优路由发布给对等体

路由更新时，BGP设备只发送更新的BGP路由

所有对等体发送的路由，BGP设备都会接收。

> BGP的Router-id是一个用于表示BGP设备的32位值，每个设备都必须有唯一的BGP ID，否则不能建立BGP连接

### BGP时间状态机

KeepAlive周期：60s

holdTime周期：180s

这个时间建议是三倍，在状态机上默认就是60/180

### next-hop-self

在EGBP传递之后，AS内部将从EBGP的接收只会会发给他们的IBGP，如果不用这个命令，那么对于IBGP来说，他们对这个路由的下一跳就是在EBGP链路上的路径，通常在IBGP上是无法到达的，所以我们需要用这个命令给调整成为EBGP自己

### Update-Source

在建立BGP对等体的时候，可以用环回接口建立邻居，这样较为稳定。

> 但是如果在EBGP对等体之间利用环回接口配置，需要开启ebgp-mutihop，因为BGP默认EBGP报文 TTL = 1，IBGP TTL - 255

### BGP同步

Synchroanition，这个技术是为了防止路由黑洞的，但是如果开启了同步，那么会增加拓扑的复杂度，并且会产生很多路由黑洞的问题，同步用一句话来说，就是如果跨设备传递路由，那么必须要保证这条路由，在接收者设备上需要底层IGP可达，否则将不会是>表项，并且将不会传递给EBGP

那么如果使用EIGRP传过去，会产生一条R>条目，而对端EBGP会产生B的路由条目。OSPF是LSA，传了也不顶事，他是内部三张表选路，并不是直接的路由

> 建议关闭，如果开启，请注意IGP传递过程以及是否在其他路由器上产生路由黑洞情况

### BGP属性

BGP选路属性一共13条，这其中有些我们可以改变，有些则无法改变，我们需要去判断的

#### Weight

名称：权重

范围：AS内生效

属性从属：Cisco私有属性，非公认属性

判断：越大越好

应用：Weight属性因为是本地属性，所以是给本地路由打标，如果有多条去向相同的路由，则选择权重最高者，其余作为BackUp路由。并且在思科的route-map中不支持OUT方向

#### Local-Preference

名称：优先级

范围：AS内生效

属性从属：公认任意

判断：越大越好

应用：local-preference的功能就是为了告知本AS内部路由器，某条路径该怎么走，一般是在ASBR上使用local-preference告知内部AS离开这个AS的路径怎么走，内部路径一般不用。

#### Next-Hop

名称：下一跳属性

范围：ALL

属性从属：公认必遵

应用：Next-Hop属性和IGP有所不同，这里不一定是邻居路由器的IP地址，在EBGP-IBGP这样的路由传递下，很有可能是其他AS的IP，这个时候就需要next-hop-self

#### As-Path

名称：路径属性

范围：ALL

属性从属：公认必遵

判断：经历越少的区域路由越优

应用：这个属性是在AS和AS之间传递的时候需要用的，主要是记录经过的AS区域，EBGP传递时检测同区域防环，在使用的时候，可以多加几个本域的AS号，这样既不会产生其他AS问题，也不会影响其他域。

> 从后往前读是数据层面，从前往后读是控制层面；并且在Route-map中只会增加不会删除

#### Origin

名称：起源属性

范围：ALL

属性从属：公认必遵

判断：I > E > ?

应用：Origin代表了路径信息的来源，标记一条路由是怎么成为BGP路由的，有IGP,EGP,Incomplete，前两种是IGP和EGP，最后一种是其他方式获取，我们一般不去改它，但是想改的话route-map里也有方法提供

#### MED

名称：多出口鉴别属性

范围：ALL，但是要取决于设置

属性从属：可选

判断：越小越好

应用：MED主要是为了让其他AS判断本AS的多出口怎么选路的，一般设置在ASBR上

> 1.如果一条路由被设置了MED，那么它将传递给所有的BGP邻居
>
> 2.如果本路由器没有设置MED，就需要遵守规则，即EBGP传进来的可以被携带，但是IBGP想传出去则不被携带，也就是说，一个AS只在他本地生效
>
> 3.MED的值会继承IGP COST值，如果是直连的，MED = 0
>
> 总结：传不出去，传的进来

#### EBGP>IBGP路由

#### 比较IGP的metric最小的，比较IGP的度量值

#### 学习到的时间越久，邻居建立越可靠

#### 比较router-id，越小的，越优先

#### 比较neighbor地址，越小越优先

### RR路由反射器

RR反射器是为了解决BGP同步带来的路由黑洞以及IBGP传递给IBGP邻居不接收的问题，涉及到Cluster-list

将一个路由器作为路由反射器，指定其他作为client客户机，有以下原则：

1. 从非客户机学到的路由，会发布给所有客户机
2. 从客户机学到的路由，发布给所有非客户机和客户机
3. 从EBGP对等体学到的路由，发布给所有非客户机和客户机

#### Cluster_List

这个是将RR和他的client组成一个Cluster，使用AS内唯一的ID作为标识，为了防止集群产生路由环路，RR使用Cluster-List记录路由经过的所有集群的Cluster ID

#### Originator_ID

当一条路由第一次被RR反射的时候，RR将Originator_ID属性加入这条路由，标识这条路由的发起设备。如果已经存在，将不会再次更新。如果本地ID和收到的路由内存在的ID相同，则不接收此路由

### BGP邦联

上一部分我们讲了RR路由反射器，而邦联也是解决路由黑洞及传递问题的一种办法

基本思想：邦联就是把大的AS内部，加入很多“小团体”，我们对外的时候，大的AS还是大的AS，但是在内部，每个小的AS之间当做“EBGP”来传递路由

> 在联邦级别的EBGP传递的时候，MED不遵循传递规则，还是看做一个大AS内部传递

### 联邦和RR的比较

|                     RR                     |                   联邦                   |
| :----------------------------------------: | :--------------------------------------: |
|        不需要更改当前拓扑，适配性好        |             需要改变逻辑拓扑             |
| 配置方便，只需要对作为反射器的设备进行配置 |           所有设备需要重新配置           |
|        集群与集群之间仍然需要全互联        | 联盟的子AS之间是特殊的EBGP，不需要全连接 |
|            适用于中、大规模网络            |             适用于大规模网络             |

### BMP

BMP是一个监控BGP运行状态，能够对网络中的设备的BGP运行状态和BGP路由处理轨迹进行实时监控，BGP运行状态包括对等体关系的建立与解除、路由信息刷新等。BGP路由的处理轨迹是指对设备内部BGP路由的加工过程。以往需要人工去查看BGP状态，使用了BMP之后就只需要通过与监控服务器的连接，向监控服务器上报其状态即可。

#### BMP消息类型

|  信息名称   |               作用               |
| :---------: | :------------------------------: |
| Initiation  | 初始化消息，向监控服务器通告信息 |
|     PU      |        报告对等体建立消息        |
|     RM      | 路由监控消息，同时通告建立和撤销 |
|     PD      |        报告对等体中断消息        |
|     SR      |       上报设备运行状态统计       |
| Termination |             结束消息             |
|    ROFT     |         路由轨迹监控消息         |

> BMP路径是单向的

### BGP GR/NSR

这是一种高可用方案，和VRRP这类节点保护不同，这是保证BGP在切换主备的时候转发层面可以继续引导数据转发的技术

#### GR(Graceful Restart --- 平滑重启)

1. GR Rrstarter：由管理员触发或故障触发后，以GR方式重启的设备
2. GR Helper：Restarter的邻居，协助进行GR的设备

#### NSR(Non-Stop Routing)

### BGP ORF

ORF(outbound routing filting)出向路由过滤，因为BGP传递路由的时候，都是在入向路由过滤，在过滤的时候，目标也只是自己，而不是其他人，但是如果有路由器不希望邻居传给他某条路由的时候就需要和邻居进行沟通，在邻居发送的时候就给拦截下来，一方面减少链路的压力，一方面减少路由器匹配prefix-list的压力。

ORF 命令有两个角色，一个是send 一个是 receive

只有send 方面才可以clear 条目，在receive上是不生效的

### BGP分层路由

emmmm没太看懂，大概是说，指定一批路由以某条路由为基础路由，传递过去的时候就以基础路由为迭代的下一跳，这样出故障的时候那一批路由全都从基础路由迭代不可达，达到快速收敛的目的，但是作用不太了解啥意思。
