## 内容简介

1. BGP简介&基础内容
2. BGP分类（角色、域）
3. BGP消息（报文）
4. BGP邻居状态机
5. BGP对等体交互原则
6. BGP时间状态机
7. next-hop-self
8. update-source
9. BGP同步
10. BGP属性
11. RR路由反射器
12. BGP邦联
13. BMP
14. BGP GR/NSR
15. BGP ORF
16. BGP分层路由

### BGP简介&基础内容

BGP（Border Gateway Protocol）边界网关路由协议，是一种EGP，不同于IGP的是它工作在AS与AS之间，为AS和AS传递路由，BGP使用TCP为其进行传输，监听端口为179。

BGP路由更新为增量更新，大大减少了链路负担，并且BGP是Loop-Free路由协议。

BGP支持CIDR

### BGP分类（角色、域）

EBGP：AS之间建立的BGP对等体邻居关系

IGBP：AS内部建立的BGP对等体邻居关系

### BGP消息

|     报文名称     |                 作用                 |
| :--------------: | :----------------------------------: |
|     Open报文     |        用于建立BGP对等体连接         |
|    Update报文    |     用于在对等体之间交换路由信息     |
| Notification报文 |           用于中断BGP连接            |
|  Keepalive报文   |           用于保持BGP连接            |
|  Route-Refresh   | 用于改变策略后请求对等体重新发送路由 |

Open报文是在TCP连接建立后发送的第一个消息，用于建立BGP对等体之间的连接关系

Keepalive报文是BGP周期性向对等体发送的消息，用于保持连接有效性

### BGP邻居状态机

|    状态     |    名称    |                          意义及作用                          |
| :---------: | :--------: | :----------------------------------------------------------: |
|    Idle     |    空闲    | 该状态是BGP的初始状态。在Idle状态下，BGP拒绝邻居发送的连接请求 |
|   Connect   |    连接    |       该状态下，BGP启动连接重传定时器，等待TCP完成连接       |
|   Active    |    活跃    |              该状态下，BGP总是在试图建立TCP连接              |
|  OpenSent   | 报文已发送 | 该状态下，BGP等待对等体的Open报文，并对收到的报文进行信息检查 |
| OpenConfirm | 报文已确认 |               该状态下，BGP等待Keep或Notif报文               |
| Established | 连接已建立 |    如果OpenConfirm为Keep，则转化为该状态，可正常传递路由     |

#### Connect

如果TCP连接成功，那么BGP向对等体发送**Open报文**

如果TCP连接失败，那么BGP转至**Active状态**

#### Active

如果TCP连接成功，那么BGP向对等体发送**Open报文**，关闭连接重传定时器

如果TCP连接失败，那么BGP停留在**Active状态**

#### OpenSent

如果收到的Open报文正确，那么BGP发送**Keepalive报文**，转至**OpenConfirm状态**

如果Open报文错误，那么会发送Notif报文回去，转至**Idle状态**

#### OpenConfirm

BGP等待Keepalive或者notifi

Keepalive：**Established**

Notif：**Idle**

#### Established

Route-Refresh报文不会改变BGP状态

收到错误的报文或者Notif，则转换到**Idle状态**

### BGP对等体交换原则

从IBGP对等体获得的BGP路由，BGP设备只发布给它的EBGP对等体

从EBGP对等体获得的BGP路由，BGP设备发布给它所有EBGP和IBGP对等体

当存在多条到达同一目的地址的有效路由时，BGP设备只将最优路由发布给对等体

路由更新时，BGP设备只发送更新的BGP路由

所有对等体发送的路由，BGP设备都会接收。

> BGP的Router-id是一个用于表示BGP设备的32位值，每个设备都必须有唯一的BGP ID，否则不能建立BGP连接

### BGP时间状态机

KeepAlive周期：60s

holdTime周期：180s

这个时间建议是三倍，在状态机上默认就是60/180

### next-hop-self

在EGBP传递之后，AS内部将从EBGP的接收只会会发给他们的IBGP，如果不用这个命令，那么对于IBGP来说，他们对这个路由的下一跳就是在EBGP链路上的路径，通常在IBGP上是无法到达的，所以我们需要用这个命令给调整成为EBGP自己

### Update-Source

在建立BGP对等体的时候，可以用环回接口建立邻居，这样较为稳定。

> 但是如果在EBGP对等体之间利用环回接口配置，需要开启ebgp-mutihop，因为BGP默认EBGP报文 TTL = 1，IBGP TTL - 255

### BGP同步

Synchroanition，这个技术是为了防止路由黑洞的，但是如果开启了同步，那么会增加拓扑的复杂度，并且会产生很多路由黑洞的问题，同步用一句话来说，就是如果跨设备传递路由，那么必须要保证这条路由，在接收者设备上需要底层IGP可达，否则将不会是>表项，并且将不会传递给EBGP

那么如果使用EIGRP传过去，会产生一条R>条目，而对端EBGP会产生B的路由条目。OSPF是LSA，传了也不顶事，他是内部三张表选路，并不是直接的路由

> 建议关闭，如果开启，请注意IGP传递过程以及是否在其他路由器上产生路由黑洞情况

### BGP属性

BGP选路属性一共13条，这其中有些我们可以改变，有些则无法改变，我们需要去判断的

#### Weight

名称：权重

范围：本地有效

属性从属：Cisco私有属性，非公认属性

优先级：1（最高）

应用：Weight属性因为是本地属性，所以是给本地路由打标，如果有多条去向相同的路由，则选择权重最高者，其余作为BackUp路由。并且在思科的route-map中不支持OUT方向

#### Local-Preference

名称：优先级

范围：AS内生效

属性从属：公认任意

优先级：2